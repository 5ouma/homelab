name: ğŸš€ Deploy

on:
  push:
    branches:
      - main
    paths:
      - "**/compose.yml"
      - "**/config/**"
      - .github/workflows/deploy.yml
      - .env.tmpl

permissions: {}

jobs:
  detect:
    name: ğŸ” Detect Changed Compose Files
    runs-on: Ubuntu-Latest
    timeout-minutes: 1
    outputs:
      compose: ${{ steps.detect.outputs.compose }}

    steps:
      - name: ğŸšš Check out repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: ğŸ” Detect changed compose files
        id: detect
        uses: ./.github/actions/detect-changed-compose

  fetch:
    name: ğŸ”„ Fetch Repository
    runs-on: Ubuntu-Latest
    timeout-minutes: 1

    steps:
      - name: ğŸ›£ï¸ Set up Tailscale
        uses: tailscale/github-action@a392da0a182bba0e9613b6243ebd69529b1878aa # v4.1.0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: "tag:actions"

      - name: ğŸ” SSH to fetch
        uses: appleboy/ssh-action@91f3272fc5907f4699dcf59761eb622a07342f5a # v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            git -C "$GIT_PATH" fetch
            git -C "$GIT_PATH" reset -q --hard origin/main
          envs: GIT_PATH
        env:
          GIT_PATH: ${{ secrets.GIT_PATH }}

  deploy:
    name: ${{ matrix.compose.name }}
    needs: [detect, fetch]
    runs-on: Ubuntu-Latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        compose: ${{ fromJson(needs.detect.outputs.compose) }}

    steps:
      - name: ğŸ›£ï¸ Set up Tailscale
        uses: tailscale/github-action@a392da0a182bba0e9613b6243ebd69529b1878aa # v4.1.0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: "tag:actions"

      - name: ğŸ” SSH to deploy
        uses: appleboy/ssh-action@91f3272fc5907f4699dcf59761eb622a07342f5a # v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: docker compose -f "$COMPOSE_DIR/compose.yml" up -d --quiet-pull --remove-orphans
          envs: COMPOSE_DIR
        env:
          COMPOSE_DIR: ${{ secrets.GIT_PATH }}/${{ matrix.compose.dir }}

  cleanup:
    name: ğŸ§¹ Cleanup Docker Images and Volumes
    needs: deploy
    runs-on: Ubuntu-Latest
    timeout-minutes: 1

    steps:
      - name: ğŸ›£ï¸ Set up Tailscale
        uses: tailscale/github-action@a392da0a182bba0e9613b6243ebd69529b1878aa # v4.1.0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: "tag:actions"

      - name: ğŸ” SSH to cleanup
        uses: appleboy/ssh-action@91f3272fc5907f4699dcf59761eb622a07342f5a # v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker image prune -af
            docker volume prune -af
